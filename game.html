<!DOCTYPE html>
<head>

</head>
<body>
<canvas id="myCanvas" width="800px" height="800px" style="border:1px solid #000000; cursor: none;"></canvas>

<script>
    var canvas = document.getElementById("myCanvas");

    var cellMultipler = 1;
    var ctx = canvas.getContext("2d");
    var screen = [];
    var objects = [];
    screenWidth = parseInt(canvas.width/cellMultipler);
    screenHeight = parseInt(canvas.height/cellMultipler);

    class Cell {
            constructor(row, column, index){
                this.row = row;
                this.column = column;
                this.index = index;
            }
    }



    // Initilizes the screen data structure.
    for (var i = 0; i < screenWidth; i++){
        var row = [];
        for (var j = 0; j < screenHeight; j++){
            row.push(new Cell(i, j, -1));
        }
        screen.push(row);
    }



   

    class GameOjb {
        constructor(cells, rise, run, color){
            this.rise = rise;
            this.run = run;
            this.cells = cells;
            this.color = color;
        }

        draw(){
            ctx.fillStyle = this.color;
            for (var i in this.cells){

                    var x = (this.cells[i].row)  * cellMultipler;
                    var y = (this.cells[i].column) * cellMultipler;

                    ctx.fillRect(x, y , cellMultipler, cellMultipler);
            }
        }
        clear(){
            for (var i in this.cells){
                var x1 = (this.cells[i].row - this.run)  * cellMultipler;
                var y1 = (this.cells[i].column - this.rise) * cellMultipler;
                ctx.clearRect(x1, y1, cellMultipler, cellMultipler);
            }
        }
        checkOtherObjectCollisions(row, column, index){
            if (screen[row][column].index !== -1 && screen[row][column].index != index){
                return true;
            }
            return false;
        }

        checkBorderCollisions(row, column){
            var changeRun = 1;
            var changeRise = 1;
            // Left Wall
            if (row < 0){
                changeRun = -1;
            }
            // Right Wall
            if (row > screenWidth - 1){
                changeRun = -1;
            }
            // Top Wall
            if (column < 0){
                changeRise = -1;       
            }
            // Buttom Wall
            if (column > screenWidth - 1){
                changeRise = -1;
            }
            return [changeRun, changeRise]
        }


        updatePos(){
            for (var i in this.cells){
                var results = this.checkBorderCollisions(this.cells[i].row + this.run, this.cells[i].column + this.rise);
                if (results[0] == -1 || results[1] == -1){
                    this.run *= results[0];
                    this.rise *= results[1];
                    return;
                }
                var otherCollision = this.checkOtherObjectCollisions(this.cells[i].row + this.run, this.cells[i].column + this.rise, this.cells[i].index);
                if (otherCollision){
                    this.rise *= -1;
                    this.run *= -1;
                    return;
                }
            }

            for (var i in this.cells){
                screen[this.cells[i].row][this.cells[i].column] = new Cell(this.cells[i].row, this.cells[i].column, -1);
                this.cells[i].row += this.run;
                this.cells[i].column += this.rise;
                screen[this.cells[i].row][this.cells[i].column] = this.cells[i];
            }
        }
        
    }

    class PlayerObj extends GameOjb {
        constructor(row, column){
            super(row, column, 'u', "#BB33FF");
        }
    }

    class AsteroidObj extends GameOjb{
        constructor(centerX, centerY, rise, run, size){
            var cellIndex = objects.length;
            var square = parseInt(Math.sqrt(size));
            var cells = [];

            // Creates a square
            for (var i = 0; i < square; i++){
                for (var j = 0; j < square; j++){
                    cells.push(new Cell(centerX + i, centerY + j, cellIndex));
                }
            } 
            // Adds the leftovers
            var leftOver = size - (square  * square); 
            if (leftOver !== 0){
                var squareX = square + centerX;
                var squareY = square + centerY;
                for (var i = 0; i < leftOver/2; i++){
                        cells.push(new Cell(squareX, centerY + i, cellIndex));
                }
                leftOver = parseInt(leftOver/=2);
                for (var i = 0; i < leftOver; i++){
                        cells.push(new Cell(centerX + i, squareY , cellIndex));
                }
            }
            
            super(cells, rise, run, "#FF2342");
        }
    }




    function drawGrid(){
        for (var i = 0; i < canvas.width/cellMultipler; i++){
            var row = [];
            ctx.beginPath();
            // Horizontal
            ctx.moveTo(i * cellMultipler, 0)
            ctx.lineTo(i * cellMultipler, canvas.height);
            // Vertical
            ctx.moveTo(0, i * cellMultipler);
            ctx.lineTo(canvas.width, i * cellMultipler);
            ctx.stroke();
        }
    }

    document.body.onkeydown = function(e){
        if (e.keyCode == 37){
            player.row -=1;
        }
        if (e.keyCode == 38){
            player.column -= 1;
        }
        if (e.keyCode == 39){
            player.row +=1
        }
        if (e.keyCode == 40){
            player.column += 1
        }
        screen[player.row][player.column] = player;
    }
    

    function upDateCanvas(){
        //ctx.clearRect(0,0, this.canvas.width, this.canvas.height);

        //drawGrid();
        for (var i in objects){
            objects[i].updatePos();
        }

        for (var i in objects){
            objects[i].clear();    
            objects[i].draw();
        }
    }
    
    function getRandomInt(min, max){
        var cal = Math.random() * (max - min)
        return Math.floor(cal) +min;
    }
    

    function addObstacle(){
        var size = getRandomInt(20, 400);
        x = getRandomInt(0 + parseInt(Math.sqrt(size)), screenWidth - parseInt(Math.sqrt(size)));
        var a = new AsteroidObj( 0 , x, -1, -1, size);
        objects.push(a);
    }

   setInterval(upDateCanvas, 60)
   addObstacle();
   setInterval(addObstacle, 1000);

</script>

</body>
